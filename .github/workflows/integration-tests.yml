name: Integration Tests

on:
  push:
    branches: [ main, develop, claude/* ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  test:
    name: Integration Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y nmap

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-test.txt

      - name: Run linting
        run: |
          pip install flake8 black mypy
          flake8 tests/ --count --select=E9,F63,F7,F82 --show-source --statistics
          black --check tests/ || true
          mypy tests/ --ignore-missing-imports || true

      - name: Run fast tests
        run: |
          pytest -v -m "not slow" --tb=short

      - name: Run critical tests
        run: |
          pytest -v -m "critical" --tb=short

      - name: Run all tests with coverage
        run: |
          pytest -v \
            --cov=. \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --junitxml=test-results.xml \
            --tb=short

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: integration-tests
          name: codecov-${{ matrix.python-version }}
          fail_ci_if_error: false

      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: test-results-${{ matrix.python-version }}
          path: |
            test-results.xml
            htmlcov/
            .coverage

      - name: Generate test report
        if: always()
        run: |
          pip install pytest-html
          pytest --html=report.html --self-contained-html || true

      - name: Upload test report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: test-report-${{ matrix.python-version }}
          path: report.html

      - name: Check coverage threshold
        run: |
          python -c "
          import xml.etree.ElementTree as ET
          tree = ET.parse('coverage.xml')
          coverage = float(tree.getroot().attrib['line-rate']) * 100
          print(f'Coverage: {coverage:.2f}%')
          assert coverage >= 85, f'Coverage {coverage:.2f}% is below threshold 85%'
          "

  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements-test.txt

      - name: Run security tests
        run: |
          pytest -v -m "security" --tb=short

      - name: Run SAST scan
        run: |
          pip install bandit
          bandit -r tests/ -f json -o bandit-report.json || true

      - name: Upload security report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: security-report
          path: bandit-report.json

  performance-tests:
    name: Performance and Concurrency Tests
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements-test.txt

      - name: Run concurrency tests
        run: |
          pytest -v -m "concurrency" --tb=short

      - name: Generate performance report
        run: |
          pytest -v -m "concurrency" --durations=20 > performance-report.txt || true

      - name: Upload performance report
        uses: actions/upload-artifact@v3
        with:
          name: performance-report
          path: performance-report.txt

  comment-pr:
    name: Comment on PR
    runs-on: ubuntu-latest
    needs: [test, security-tests, performance-tests]
    if: github.event_name == 'pull_request'

    steps:
      - name: Download test results
        uses: actions/download-artifact@v3
        with:
          name: test-results-3.11
          path: ./results

      - name: Comment PR with results
        uses: actions/github-script@v6
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const fs = require('fs');

            let comment = '## Integration Test Results\n\n';
            comment += 'âœ… All integration tests passed!\n\n';
            comment += '### Coverage\n';
            comment += 'See artifacts for detailed coverage report.\n\n';
            comment += '### Test Categories\n';
            comment += '- API Endpoint Tests\n';
            comment += '- Tool Integration Tests\n';
            comment += '- Security Tests\n';
            comment += '- Concurrency Tests\n';
            comment += '- Edge Case Tests\n';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
