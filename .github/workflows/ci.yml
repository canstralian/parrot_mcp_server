name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint:
    name: Lint Shell Scripts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install ShellCheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Install shfmt
        run: |
          wget -qO- https://github.com/mvdan/sh/releases/download/v3.7.0/shfmt_v3.7.0_linux_amd64 -O /tmp/shfmt
          chmod +x /tmp/shfmt
          sudo mv /tmp/shfmt /usr/local/bin/

      - name: Lint all shell scripts with ShellCheck
        run: |
          find . -name "*.sh" -type f ! -path "./.git/*" | xargs shellcheck

      - name: Check shell formatting
        run: |
          find . -name "*.sh" -type f ! -path "./.git/*" | xargs shfmt -d

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Grant execute permissions
        run: chmod +x ./rpi-scripts/*.sh

      - name: Run MCP protocol tests
        run: |
          cd rpi-scripts
          bash ./test_mcp_local.sh

      - name: Check test artifacts
        run: |
          if [ -f ./rpi-scripts/logs/parrot.log ]; then
            echo "✓ Server log created successfully"
            cat ./rpi-scripts/logs/parrot.log
          else
            echo "✗ Server log not found"
            exit 1
          fi

  security:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner in repo mode
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Check for security issues in scripts
        run: |
          echo "Checking for common security issues..."
          ! grep -rn "eval" --include="*.sh" . || (echo "Warning: eval usage found" && exit 1)
          ! grep -rn "source /dev/stdin" --include="*.sh" . || (echo "Warning: sourcing from stdin found" && exit 1)

  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [test, security]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: parrot-mcp-server:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Install Hadolint (Dockerfile linter)
        run: |
          wget -qO /tmp/hadolint https://github.com/hadolint/hadolint/releases/download/v2.12.0/hadolint-Linux-x86_64
          chmod +x /tmp/hadolint
          sudo mv /tmp/hadolint /usr/local/bin/

      - name: Lint Dockerfile
        run: hadolint Dockerfile

      - name: Scan Docker image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'parrot-mcp-server:${{ github.sha }}'
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Grant execute permissions
        run: chmod +x ./rpi-scripts/*.sh

      - name: Start MCP server
        run: |
          cd rpi-scripts
          ./start_mcp_server.sh
          sleep 3

      - name: Verify server is running
        run: |
          if [ -f ./rpi-scripts/logs/mcp_server.pid ]; then
            PID=$(cat ./rpi-scripts/logs/mcp_server.pid)
            if ps -p "$PID" > /dev/null; then
              echo "✓ Server is running with PID $PID"
            else
              echo "✗ Server process not found"
              exit 1
            fi
          else
            echo "✗ PID file not found"
            exit 1
          fi

      - name: Stop MCP server
        if: always()
        run: |
          cd rpi-scripts
          ./stop_mcp_server.sh || true

  report:
    name: Generate Test Report
    runs-on: ubuntu-latest
    needs: [lint, test, security, build, integration]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## CI Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "✅ All checks passed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Linting: Complete" >> $GITHUB_STEP_SUMMARY
          echo "- Tests: Complete" >> $GITHUB_STEP_SUMMARY
          echo "- Security: Complete" >> $GITHUB_STEP_SUMMARY
          echo "- Build: Complete" >> $GITHUB_STEP_SUMMARY
          echo "- Integration: Complete" >> $GITHUB_STEP_SUMMARY
